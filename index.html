<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚®ãƒ£ã‚¯ãƒãƒªå›</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@700;900&family=Bangers&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans JP', sans-serif; }
        .title-font { font-family: 'Bangers', cursive; }
        .gradient-text { background: linear-gradient(135deg, #f093fb, #f5576c); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    </style>
</head>
<body class="min-h-screen" style="background: linear-gradient(135deg, #667eea, #764ba2, #f093fb)">
    <div class="max-w-2xl mx-auto p-4 pb-20">
        <div class="bg-white/95 rounded-2xl shadow-2xl p-5 mb-4">
            <h1 class="text-5xl font-black text-center title-font gradient-text">ã‚®ãƒ£ã‚¯ãƒãƒªå›</h1>
            <p class="text-center text-sm text-gray-600 mt-2 font-bold">ğŸ“± URLã‚’å…¥ã‚Œã‚‹ã ã‘ï¼</p>
        </div>
        <div id="app"></div>
    </div>

    <script>
        let mode = 'normal', betType = '', raceData = null, predictions = null;

        function render() {
            const app = document.getElementById('app');
            if (!raceData) showInput();
            else if (!predictions) showSettings();
            else showResults();
        }

        function showInput() {
            app.innerHTML = `
                <div class="space-y-4">
                    <div class="bg-blue-50 border-2 border-blue-300 rounded-lg p-4">
                        <h3 class="font-black text-base mb-2">ğŸ“± ç°¡å˜2ã‚¹ãƒ†ãƒƒãƒ—</h3>
                        <ol class="space-y-2 text-sm">
                            <li><strong>1.</strong> netkeibaã§å‡ºé¦¬è¡¨ã‚’é–‹ã</li>
                            <li><strong>2.</strong> URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦è²¼ã‚Šä»˜ã‘</li>
                        </ol>
                    </div>
                    <div class="bg-white/95 rounded-xl shadow-xl p-5">
                        <h2 class="text-lg font-bold mb-3">ğŸ”— netkeibaã®URL</h2>
                        <input id="url" type="url" placeholder="https://race.netkeiba.com/race/shutuba.html?race_id=..." 
                            class="w-full px-4 py-4 border-2 border-purple-300 rounded-lg mb-3" style="font-size:16px">
                        <div class="bg-gray-50 p-3 rounded mb-3 text-xs">
                            <strong>ä¾‹:</strong> https://race.netkeiba.com/race/shutuba.html?race_id=202605010611
                        </div>
                        <button onclick="fetchRace()" class="w-full py-5 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-xl font-black text-xl shadow-lg">
                            ğŸ” äºˆæƒ³ã‚¹ã‚¿ãƒ¼ãƒˆ
                        </button>
                    </div>
                    <div id="status"></div>
                </div>
            `;
        }

        async function fetchRace() {
            const url = document.getElementById('url').value;
            const status = document.getElementById('status');
            
            if (!url?.includes('netkeiba.com')) {
                status.innerHTML = '<div class="bg-red-50 border-2 border-red-300 rounded-lg p-3"><p class="text-red-700 font-bold text-sm">âš ï¸ netkeibaã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p></div>';
                return;
            }

            status.innerHTML = '<div class="bg-blue-50 border-2 border-blue-300 rounded-lg p-3"><p class="text-blue-700 font-bold text-sm">ğŸ”„ ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...</p></div>';

            try {
                console.log('Fetching:', url);
                const response = await fetch(`/api/proxy?url=${encodeURIComponent(url)}`);
                
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Error data:', errorData);
                    throw new Error(JSON.stringify(errorData, null, 2));
                }
                
                const html = await response.text();
                console.log('HTML received, length:', html.length);
                
                raceData = parseHTML(html);
                console.log('Parsed horses:', raceData.horses.length);
                
                if (raceData.horses.length > 0) {
                    status.innerHTML = '<div class="bg-green-50 border-2 border-green-300 rounded-lg p-3"><p class="text-green-700 font-bold text-sm">âœ… æˆåŠŸï¼</p></div>';
                    setTimeout(() => render(), 500);
                    return;
                }
                
                throw new Error('å‡ºèµ°é¦¬ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
            } catch (error) {
                console.error('Error:', error);
                status.innerHTML = `
                    <div class="bg-red-50 border-2 border-red-300 rounded-lg p-4">
                        <p class="text-red-700 font-bold mb-2">âŒ ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</p>
                        <details class="text-xs text-red-600 mt-2">
                            <summary class="cursor-pointer font-bold">è©³ç´°ã‚’è¦‹ã‚‹</summary>
                            <pre class="mt-2 p-2 bg-white rounded overflow-auto text-xs">${error.message}</pre>
                        </details>
                        <p class="text-red-600 text-xs mt-2">URLã‚’ç¢ºèªã—ã¦ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ãã ã•ã„</p>
                    </div>
                `;
            }
        }

        function parseHTML(html) {
            const doc = new DOMParser().parseFromString(html, 'text/html');
            
            // ãƒ¬ãƒ¼ã‚¹å
            const name = doc.querySelector('.RaceName')?.textContent?.trim() || 'ä¸æ˜';
            
            // ãƒ¬ãƒ¼ã‚¹æƒ…å ±
            const data = (doc.querySelector('.RaceData01')?.textContent || '') + (doc.querySelector('.RaceData02')?.textContent || '');
            const dist = data.match(/(\d{3,4})m/)?.[1] || '2000';
            const track = data.includes('ãƒ€') ? 'ãƒ€ãƒ¼ãƒˆ' : 'èŠ';
            const loc = data.match(/(æ±äº¬|ä¸­å±±|äº¬éƒ½|é˜ªç¥|ä¸­äº¬|æ–°æ½Ÿ|ç¦å³¶|å°å€‰|æœ­å¹Œ|å‡½é¤¨)/)?.[1] || 'ä¸æ˜';
            
            const horses = [];
            const rows = doc.querySelectorAll('.Shutuba_Table tbody tr, table tbody tr');
            
            console.log(`Found ${rows.length} rows`);
            
            rows.forEach((row, idx) => {
                try {
                    const cells = Array.from(row.querySelectorAll('td'));
                    if (cells.length < 5) return;
                    
                    // é¦¬ç•ªã‚’æ¢ã™
                    let num = null;
                    const umabanElem = row.querySelector('.Umaban');
                    if (umabanElem) {
                        num = parseInt(umabanElem.textContent.trim());
                    } else {
                        for (let i = 0; i < Math.min(3, cells.length); i++) {
                            const text = cells[i].textContent.trim();
                            if (/^\d+$/.test(text)) {
                                const n = parseInt(text);
                                if (n >= 1 && n <= 30) {
                                    num = n;
                                    break;
                                }
                            }
                        }
                    }
                    
                    if (!num) return;
                    
                    // é¦¬å
                    const nameElem = row.querySelector('a[href*="/horse/"]');
                    const horseName = nameElem?.textContent?.trim() || `${num}ç•ª`;
                    
                    // é¨æ‰‹
                    const jockeyElem = row.querySelector('a[href*="/jockey/"]');
                    const jockey = jockeyElem?.textContent?.trim() || 'æœªå®š';
                    
                    // ã‚ªãƒƒã‚ºã‚’æ¢ã™ï¼ˆ.Popularã‚¯ãƒ©ã‚¹ã¾ãŸã¯ç‰¹å®šã®ä½ç½®ï¼‰
                    let odds = 10.0;
                    
                    // æ–¹æ³•1: .Popularã‚¯ãƒ©ã‚¹
                    const popularElem = row.querySelector('.Popular');
                    if (popularElem) {
                        const oddsText = popularElem.textContent.trim();
                        const oddsMatch = oddsText.match(/(\d+\.\d+)/);
                        if (oddsMatch) {
                            odds = parseFloat(oddsMatch[1]);
                        }
                    }
                    
                    // æ–¹æ³•2: ã‚»ãƒ«ã‚’é †ç•ªã«æ¢ã™ï¼ˆæ–¤é‡ã‚’é™¤å¤–ï¼‰
                    if (odds === 10.0) {
                        const weightValues = [54.0, 55.0, 56.0, 57.0, 58.0]; // é™¤å¤–ã™ã‚‹æ–¤é‡
                        
                        for (const cell of cells) {
                            const text = cell.textContent.trim();
                            if (/^\d+\.\d+$/.test(text)) {
                                const value = parseFloat(text);
                                if (value >= 1.0 && value <= 999.0 && !weightValues.includes(value)) {
                                    odds = value;
                                    break;
                                }
                            }
                        }
                    }
                    
                    console.log(`Horse ${num}: ${horseName}, ${jockey}, odds=${odds}`);
                    
                    horses.push({
                        number: num,
                        name: horseName,
                        jockey: jockey,
                        odds: odds
                    });
                } catch (err) {
                    console.error(`Row ${idx} error:`, err);
                }
            });
            
            horses.sort((a, b) => a.number - b.number);
            console.log(`Total: ${horses.length} horses`);
            
            return { raceName: name, location: loc, distance: dist, trackType: track, horses };
        }

        function showSettings() {
            app.innerHTML = `
                <div class="space-y-4">
                    <button onclick="raceData=null;render()" class="text-white font-bold underline">â† æˆ»ã‚‹</button>
                    <div class="bg-white/95 rounded-xl shadow-xl p-5">
                        <h2 class="text-lg font-bold mb-3">ğŸ“Š ${raceData.raceName}</h2>
                        <div class="bg-blue-50 p-3 rounded mb-2">
                            <div class="text-sm">${raceData.location} | ${raceData.distance}m ${raceData.trackType}</div>
                        </div>
                        <div class="bg-green-50 p-2 rounded">
                            <div class="text-xs font-bold text-green-800">âœ… ${raceData.horses.length}é ­</div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="mode='normal';render()" class="${mode==='normal'?'bg-gradient-to-r from-blue-500 to-cyan-500 text-white':'bg-white/80'} p-5 rounded-xl font-bold">
                            <div class="text-3xl">ğŸ¯</div><div class="text-sm">å …å®Ÿ</div>
                            <div class="text-xs mt-1 opacity-80">çš„ä¸­é‡è¦–</div>
                        </button>
                        <button onclick="mode='gyakubari';render()" class="${mode==='gyakubari'?'bg-gradient-to-r from-pink-500 to-red-500 text-white':'bg-white/80'} p-5 rounded-xl font-bold">
                            <div class="text-3xl">ğŸ’£</div><div class="text-sm">ã‚®ãƒ£ã‚¯ãƒãƒªå›</div>
                            <div class="text-xs mt-1 opacity-80">å¤§ç©´ä¸€æ”«åƒé‡‘</div>
                        </button>
                    </div>
                    <div class="bg-white/95 rounded-xl shadow-xl p-5">
                        <h2 class="text-lg font-bold mb-3">ğŸ² è³­ã‘æ–¹</h2>
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="betType='tansho';predict()" class="p-4 bg-white border-2 rounded-lg font-bold hover:bg-purple-50">å˜å‹</button>
                            <button onclick="betType='fukusho';predict()" class="p-4 bg-white border-2 rounded-lg font-bold hover:bg-purple-50">è¤‡å‹</button>
                            <button onclick="betType='umaren';predict()" class="p-4 bg-white border-2 rounded-lg font-bold hover:bg-purple-50">é¦¬é€£</button>
                            <button onclick="betType='wide';predict()" class="p-4 bg-white border-2 rounded-lg font-bold hover:bg-purple-50">ãƒ¯ã‚¤ãƒ‰</button>
                            <button onclick="betType='umatan';predict()" class="p-4 bg-white border-2 rounded-lg font-bold hover:bg-purple-50">é¦¬å˜</button>
                            <button onclick="betType='sanrenpuku';predict()" class="p-4 bg-white border-2 rounded-lg font-bold hover:bg-purple-50">ä¸‰é€£è¤‡</button>
                            <button onclick="betType='sanrentan';predict()" class="p-4 bg-white border-2 rounded-lg font-bold hover:bg-purple-50">ä¸‰é€£å˜</button>
                        </div>
                    </div>
                    <div id="status"></div>
                </div>
            `;
        }

        async function predict() {
            if (!betType) {
                document.getElementById('status').innerHTML = '<div class="bg-red-50 p-3 rounded"><p class="text-red-700 text-sm">è³­ã‘æ–¹ã‚’é¸æŠã—ã¦ãã ã•ã„</p></div>';
                return;
            }
            
            const statusDiv = document.getElementById('status') || (() => {
                const div = document.createElement('div');
                div.id = 'status';
                app.appendChild(div);
                return div;
            })();
            
            statusDiv.innerHTML = '<div class="bg-blue-50 border-2 border-blue-300 rounded-lg p-4"><p class="text-blue-700 font-bold">ğŸ¤– AIãŒäºˆæƒ³ã‚’åˆ†æä¸­...</p><p class="text-xs text-blue-600 mt-1">é¨æ‰‹å®ŸåŠ›ãƒ»è·é›¢é©æ€§ãƒ»é¦¬å ´çŠ¶æ…‹ãªã©ã‚’ç·åˆçš„ã«åˆ¤æ–­ã—ã¦ã„ã¾ã™</p></div>';
            
            try {
                // AIäºˆæƒ³APIã‚’å‘¼ã³å‡ºã—
                const response = await fetch('/api/predict', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        horses: raceData.horses,
                        betType: betType,
                        mode: mode,
                        raceInfo: {
                            raceName: raceData.raceName,
                            location: raceData.location,
                            distance: raceData.distance,
                            trackType: raceData.trackType
                        }
                    })
                });
                
                if (!response.ok) {
                    throw new Error('AI prediction failed');
                }
                
                const data = await response.json();
                
                // é¦¬ç•ªã‹ã‚‰é¦¬ã®æƒ…å ±ã‚’å–å¾—
                const recommendations = data.predictions.map(pred => ({
                    ...pred,
                    horses: pred.horses.map(num => raceData.horses.find(h => h.number === num)).filter(h => h)
                }));
                
                predictions = { mode, betType, recommendations };
                statusDiv.remove();
                render();
            } catch (error) {
                console.error('Prediction error:', error);
                statusDiv.innerHTML = `
                    <div class="bg-red-50 border-2 border-red-300 rounded-lg p-4">
                        <p class="text-red-700 font-bold mb-2">âŒ AIäºˆæƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ</p>
                        <p class="text-red-600 text-xs">ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ãã ã•ã„</p>
                    </div>
                `;
            }
        }

        function showResults() {
            const e = mode==='gyakubari'?'ğŸ’£':'ğŸ¯';
            const betTypeLabel = betTypes.find(b => b.value === predictions.betType)?.label || 'é¦¬åˆ¸';
            
            app.innerHTML = `
                <div class="space-y-4">
                    <button onclick="predictions=null;betType='';render()" class="text-white font-bold underline">â† æˆ»ã‚‹</button>
                    
                    <div class="bg-white/95 rounded-xl shadow-xl p-5">
                        <h2 class="text-xl font-bold mb-2">${e} ${betTypeLabel}ã®ãŠã™ã™ã‚</h2>
                        <div class="text-sm text-gray-600 mb-3">${raceData.raceName}</div>
                        
                        ${predictions.recommendations.map((rec, i) => `
                            <div class="border-4 ${['border-yellow-400 bg-yellow-50','border-blue-400 bg-blue-50','border-green-400 bg-green-50'][i] || 'border-gray-400 bg-gray-50'} rounded-lg p-4 mb-3">
                                <div class="flex justify-between items-center mb-3">
                                    <div class="text-xl font-black">${rec.title}</div>
                                    <div class="text-right">
                                        <div class="text-xs text-gray-600">çš„ä¸­ç‡</div>
                                        <div class="text-2xl font-black text-green-600">${rec.confidence}%</div>
                                    </div>
                                </div>
                                
                                <div class="flex flex-wrap gap-2 mb-3">
                                    ${rec.horses.map(h => `
                                        <div class="bg-white border-4 border-purple-600 px-6 py-3 rounded-lg">
                                            <span class="text-3xl font-black text-purple-600">${h.number}</span>
                                        </div>
                                    `).join('')}
                                </div>
                                
                                <div class="space-y-2 mb-3">
                                    ${rec.horses.map(h => `
                                        <div class="bg-white/90 p-2 rounded text-sm">
                                            <div class="flex justify-between items-center">
                                                <div>
                                                    <span class="font-bold">${h.number}</span>
                                                    <span class="ml-2">${h.name}</span>
                                                    <span class="text-gray-600 ml-2 text-xs">${h.jockey}</span>
                                                </div>
                                                <div class="font-bold text-red-600">${h.odds}å€</div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                                
                                <div class="bg-white/90 p-3 rounded mb-2">
                                    <div class="text-xs font-bold text-gray-600 mb-1">ğŸ’¡ è²·ã„ç›®</div>
                                    <div class="text-sm font-bold">${rec.reasoning}</div>
                                </div>
                                
                                <div class="flex justify-between items-center">
                                    <span class="text-sm font-bold text-gray-700">æœŸå¾…å›åç‡</span>
                                    <span class="text-2xl font-black text-blue-600">${rec.expectedReturn}%</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded-lg">
                        <p class="text-xs font-bold text-yellow-900 mb-1">âš ï¸ é‡è¦</p>
                        <ul class="text-xs text-yellow-900 space-y-1">
                            <li>â€¢ çš„ä¸­ã‚’ä¿è¨¼ã™ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“</li>
                            <li>â€¢ é¦¬åˆ¸è³¼å…¥ã¯è‡ªå·±è²¬ä»»ã§</li>
                            <li>â€¢ ã‚®ãƒ£ãƒ³ãƒ–ãƒ«ã¯ã»ã©ã»ã©ã«</li>
                        </ul>
                    </div>
                </div>
            `;
        }

        render();
    </script>
</body>
</html>
