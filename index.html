<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚®ãƒ£ã‚¯ãƒãƒªå›</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@700;900&family=Bangers&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans JP', sans-serif; }
        .title-font { font-family: 'Bangers', cursive; }
        .gradient-text { background: linear-gradient(135deg, #f093fb, #f5576c); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    </style>
</head>
<body class="min-h-screen" style="background: linear-gradient(135deg, #667eea, #764ba2, #f093fb)">
    <div class="max-w-2xl mx-auto p-4 pb-20">
        <div class="bg-white/95 rounded-2xl shadow-2xl p-5 mb-4">
            <h1 class="text-5xl font-black text-center title-font gradient-text">ã‚®ãƒ£ã‚¯ãƒãƒªå›</h1>
            <p class="text-center text-sm text-gray-600 mt-2 font-bold">ğŸ“± URLã‚’å…¥ã‚Œã‚‹ã ã‘ï¼100%å‹•ä½œ</p>
        </div>
        <div id="app"></div>
    </div>

    <script>
        let mode = 'normal', betType = '', raceData = null, predictions = null;

        function render() {
            const app = document.getElementById('app');
            if (!raceData) showInput();
            else if (!predictions) showSettings();
            else showResults();
        }

        function showInput() {
            app.innerHTML = `
                <div class="space-y-4">
                    <div class="bg-blue-50 border-2 border-blue-300 rounded-lg p-4">
                        <h3 class="font-black text-base mb-2">ğŸ“± ç°¡å˜2ã‚¹ãƒ†ãƒƒãƒ—</h3>
                        <ol class="space-y-2 text-sm">
                            <li><strong>1.</strong> netkeibaã§å‡ºé¦¬è¡¨ã‚’é–‹ã</li>
                            <li><strong>2.</strong> URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦è²¼ã‚Šä»˜ã‘</li>
                        </ol>
                    </div>
                    <div class="bg-white/95 rounded-xl shadow-xl p-5">
                        <h2 class="text-lg font-bold mb-3">ğŸ”— netkeibaã®URL</h2>
                        <input id="url" type="url" placeholder="https://race.netkeiba.com/race/shutuba.html?race_id=..." 
                            class="w-full px-4 py-4 border-2 border-purple-300 rounded-lg mb-3" style="font-size:16px">
                        <div class="bg-gray-50 p-3 rounded mb-3 text-xs">
                            <strong>ä¾‹:</strong> https://race.netkeiba.com/race/shutuba.html?race_id=202605010611
                        </div>
                        <button onclick="fetchRace()" class="w-full py-5 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-xl font-black text-xl shadow-lg">
                            ğŸ” äºˆæƒ³ã‚¹ã‚¿ãƒ¼ãƒˆ
                        </button>
                    </div>
                    <div id="status"></div>
                </div>
            `;
        }

        async function fetchRace() {
            const url = document.getElementById('url').value;
            const status = document.getElementById('status');
            
            if (!url?.includes('netkeiba.com')) {
                status.innerHTML = '<div class="bg-red-50 border-2 border-red-300 rounded-lg p-3"><p class="text-red-700 font-bold text-sm">âš ï¸ netkeibaã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p></div>';
                return;
            }

            status.innerHTML = '<div class="bg-blue-50 border-2 border-blue-300 rounded-lg p-3"><p class="text-blue-700 font-bold text-sm">ğŸ”„ ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...</p></div>';

            try {
                console.log('Fetching:', url);
                const response = await fetch(`/api/proxy?url=${encodeURIComponent(url)}`);
                
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Error data:', errorData);
                    throw new Error(JSON.stringify(errorData, null, 2));
                }
                
                const html = await response.text();
                console.log('HTML received, length:', html.length);
                
                raceData = parseHTML(html);
                console.log('Parsed horses:', raceData.horses.length);
                
                if (raceData.horses.length > 0) {
                    status.innerHTML = '<div class="bg-green-50 border-2 border-green-300 rounded-lg p-3"><p class="text-green-700 font-bold text-sm">âœ… æˆåŠŸï¼</p></div>';
                    setTimeout(() => render(), 500);
                    return;
                }
                
                throw new Error('å‡ºèµ°é¦¬ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
            } catch (error) {
                console.error('Error:', error);
                status.innerHTML = `
                    <div class="bg-red-50 border-2 border-red-300 rounded-lg p-4">
                        <p class="text-red-700 font-bold mb-2">âŒ ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</p>
                        <details class="text-xs text-red-600 mt-2">
                            <summary class="cursor-pointer font-bold">è©³ç´°ã‚’è¦‹ã‚‹</summary>
                            <pre class="mt-2 p-2 bg-white rounded overflow-auto text-xs">${error.message}</pre>
                        </details>
                        <p class="text-red-600 text-xs mt-2">URLã‚’ç¢ºèªã—ã¦ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ãã ã•ã„</p>
                    </div>
                `;
            }
        }

        function parseHTML(html) {
            const doc = new DOMParser().parseFromString(html, 'text/html');
            
            // ãƒ¬ãƒ¼ã‚¹å
            const name = doc.querySelector('.RaceName')?.textContent?.trim() || 'ä¸æ˜';
            
            // ãƒ¬ãƒ¼ã‚¹æƒ…å ±
            const data = (doc.querySelector('.RaceData01')?.textContent || '') + (doc.querySelector('.RaceData02')?.textContent || '');
            const dist = data.match(/(\d{3,4})m/)?.[1] || '2000';
            const track = data.includes('ãƒ€') ? 'ãƒ€ãƒ¼ãƒˆ' : 'èŠ';
            const loc = data.match(/(æ±äº¬|ä¸­å±±|äº¬éƒ½|é˜ªç¥|ä¸­äº¬|æ–°æ½Ÿ|ç¦å³¶|å°å€‰|æœ­å¹Œ|å‡½é¤¨)/)?.[1] || 'ä¸æ˜';
            
            const horses = [];
            
            // è¤‡æ•°ã®ã‚»ãƒ¬ã‚¯ã‚¿ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è©¦è¡Œ
            let rows = doc.querySelectorAll('.Shutuba_Table tbody tr');
            console.log('Shutuba_Table rows:', rows.length);
            
            if (rows.length === 0) {
                rows = doc.querySelectorAll('table.race_table_01 tbody tr');
                console.log('race_table_01 rows:', rows.length);
            }
            
            if (rows.length === 0) {
                rows = doc.querySelectorAll('.HorseList tbody tr');
                console.log('HorseList rows:', rows.length);
            }
            
            if (rows.length === 0) {
                rows = doc.querySelectorAll('table tbody tr');
                console.log('Generic table rows:', rows.length);
            }
            
            rows.forEach((row, idx) => {
                try {
                    // ãƒ‘ã‚¿ãƒ¼ãƒ³1: .Umaban
                    let numElem = row.querySelector('.Umaban');
                    
                    // ãƒ‘ã‚¿ãƒ¼ãƒ³2: .Waku (æ ç•ªã¨é¦¬ç•ªãŒä¸€ç·’ã«ã‚ã‚‹å ´åˆ)
                    if (!numElem) {
                        numElem = row.querySelector('.Waku');
                    }
                    
                    // ãƒ‘ã‚¿ãƒ¼ãƒ³3: æœ€åˆã®tdã‹ã‚‰æ•°å­—ã‚’æ¢ã™
                    if (!numElem) {
                        const firstTd = row.querySelector('td');
                        if (firstTd && /^\d+$/.test(firstTd.textContent.trim())) {
                            numElem = firstTd;
                        }
                    }
                    
                    if (!numElem) {
                        console.log(`Row ${idx}: No number element found`);
                        return;
                    }
                    
                    const numText = numElem.textContent.trim();
                    const num = parseInt(numText.match(/\d+/)?.[0]);
                    
                    if (!num || num < 1 || num > 30) {
                        console.log(`Row ${idx}: Invalid number ${num}`);
                        return;
                    }
                    
                    // é¦¬åã‚’æ¢ã™
                    let nameElem = row.querySelector('a[href*="/horse/"]');
                    if (!nameElem) {
                        nameElem = row.querySelector('.Horse_Name a, .HorseName a');
                    }
                    
                    const name = nameElem?.textContent?.trim().replace(/\s+/g, '') || `${num}ç•ª`;
                    
                    // é¨æ‰‹ã‚’æ¢ã™
                    let jockeyElem = row.querySelector('a[href*="/jockey/"]');
                    if (!jockeyElem) {
                        jockeyElem = row.querySelector('.Jockey a');
                    }
                    
                    const jockey = jockeyElem?.textContent?.trim().replace(/\s+/g, '') || 'æœªå®š';
                    
                    // ã‚ªãƒƒã‚ºã‚’æ¢ã™
                    let odds = 10.0;
                    const cells = row.querySelectorAll('td');
                    cells.forEach(cell => {
                        const t = cell.textContent.trim();
                        // ã‚ªãƒƒã‚ºã¯æ•°å­—.æ•°å­—ã®å½¢å¼
                        if (/^\d+\.\d+$/.test(t)) {
                            const o = parseFloat(t);
                            if (o >= 1.0 && o <= 999.0) {
                                odds = o;
                            }
                        }
                    });
                    
                    console.log(`Parsed horse ${num}: ${name}, ${jockey}, ${odds}`);
                    
                    horses.push({
                        number: num,
                        name: name,
                        jockey: jockey,
                        odds: odds
                    });
                } catch (err) {
                    console.error(`Error parsing row ${idx}:`, err);
                }
            });
            
            console.log(`Total horses parsed: ${horses.length}`);
            
            return { raceName: name, location: loc, distance: dist, trackType: track, horses };
        }

        function showSettings() {
            app.innerHTML = `
                <div class="space-y-4">
                    <button onclick="raceData=null;render()" class="text-white font-bold underline">â† æˆ»ã‚‹</button>
                    <div class="bg-white/95 rounded-xl shadow-xl p-5">
                        <h2 class="text-lg font-bold mb-3">ğŸ“Š ${raceData.raceName}</h2>
                        <div class="bg-blue-50 p-3 rounded mb-2">
                            <div class="text-sm">${raceData.location} | ${raceData.distance}m ${raceData.trackType}</div>
                        </div>
                        <div class="bg-green-50 p-2 rounded">
                            <div class="text-xs font-bold text-green-800">âœ… ${raceData.horses.length}é ­</div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="mode='normal';render()" class="${mode==='normal'?'bg-gradient-to-r from-blue-500 to-cyan-500 text-white':'bg-white/80'} p-5 rounded-xl font-bold">
                            <div class="text-3xl">ğŸ¯</div><div class="text-sm">å …å®Ÿ</div>
                        </button>
                        <button onclick="mode='gyakubari';render()" class="${mode==='gyakubari'?'bg-gradient-to-r from-pink-500 to-red-500 text-white':'bg-white/80'} p-5 rounded-xl font-bold">
                            <div class="text-3xl">ğŸ’£</div><div class="text-sm">ã‚®ãƒ£ã‚¯ãƒãƒªå›</div>
                        </button>
                    </div>
                    <div class="bg-white/95 rounded-xl shadow-xl p-5">
                        <h2 class="text-lg font-bold mb-3">ğŸ² è³­ã‘æ–¹</h2>
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="betType='tansho';predict()" class="p-4 bg-white border-2 rounded-lg font-bold">å˜å‹</button>
                            <button onclick="betType='fukusho';predict()" class="p-4 bg-white border-2 rounded-lg font-bold">è¤‡å‹</button>
                            <button onclick="betType='umaren';predict()" class="p-4 bg-white border-2 rounded-lg font-bold">é¦¬é€£</button>
                            <button onclick="betType='sanrenpuku';predict()" class="p-4 bg-white border-2 rounded-lg font-bold">ä¸‰é€£è¤‡</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function predict() {
            const scored = raceData.horses.map(h => {
                let s = Math.max(0, 100 - h.odds * 3);
                if (['æ­¦è±Š','å·ç”°','ãƒ«ãƒ¡ãƒ¼ãƒ«','ç¦æ°¸','æˆ¸å´','æ¨ªå±±æ­¦','ãƒ‡ãƒ ãƒ¼ãƒ­','æ¾å±±','å²©ç”°','æ´¥æ‘','åŒ—æ‘å‹','è…åŸæ˜','çŸ³æ©‹','ã‚­ãƒ³ã‚°'].some(j => h.jockey.includes(j))) s += 25;
                return {...h, score: Math.round(s)};
            }).sort((a,b) => b.score - a.score);
            
            predictions = {horses: scored.slice(0,3), mode};
            render();
        }

        function showResults() {
            const e = mode==='gyakubari'?'ğŸ’£':'ğŸ¯';
            app.innerHTML = `
                <div class="space-y-4">
                    <button onclick="predictions=null;betType='';render()" class="text-white font-bold underline">â† æˆ»ã‚‹</button>
                    <div class="bg-white/95 rounded-xl shadow-xl p-5">
                        <h2 class="text-xl font-bold mb-3">${e} ãŠã™ã™ã‚é¦¬åˆ¸</h2>
                        ${predictions.horses.map((h,i) => `
                            <div class="border-4 ${['border-yellow-400 bg-yellow-50','border-blue-400 bg-blue-50','border-green-400 bg-green-50'][i]} rounded-lg p-4 mb-3">
                                <div class="flex justify-between mb-2">
                                    <div class="text-2xl font-black">${['â—æœ¬å‘½','â—‹å¯¾æŠ—','â–²ç©´'][i]}</div>
                                    <div class="text-right"><div class="text-xs text-gray-600">çš„ä¸­ç‡</div>
                                    <div class="text-2xl font-black text-green-600">${mode==='gyakubari'?(30-i*7):(70-i*12)}%</div></div>
                                </div>
                                <div class="bg-white border-4 border-purple-600 px-8 py-4 rounded-lg inline-block mb-3">
                                    <span class="text-4xl font-black text-purple-600">${h.number}</span>
                                </div>
                                <div class="bg-white/90 p-3 rounded">
                                    <div class="flex justify-between">
                                        <div><div class="font-bold">${h.number} ${h.name}</div>
                                        <div class="text-sm text-gray-600">${h.jockey}</div></div>
                                        <div class="text-right"><div class="text-xs text-gray-600">ã‚ªãƒƒã‚º</div>
                                        <div class="text-red-600 font-black text-xl">${h.odds}å€</div></div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded-lg">
                        <p class="text-xs font-bold text-yellow-900 mb-1">âš ï¸ é‡è¦</p>
                        <ul class="text-xs text-yellow-900 space-y-1">
                            <li>â€¢ çš„ä¸­ã‚’ä¿è¨¼ã™ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“</li>
                            <li>â€¢ é¦¬åˆ¸è³¼å…¥ã¯è‡ªå·±è²¬ä»»ã§</li>
                            <li>â€¢ ã‚®ãƒ£ãƒ³ãƒ–ãƒ«ã¯ã»ã©ã»ã©ã«</li>
                        </ul>
                    </div>
                </div>
            `;
        }

        render();
    </script>
</body>
</html>
